<!DOCTYPE html>
<html>
<head>
    <title>Supabase Connection Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Supabase Connection Test</h1>

    <div id="results"></div>

    <button onclick="runTests()">Run Connection Test</button>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const SUPABASE_URL = 'https://cymticrjzidywukflwtv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5bXRpY3JqemlkeXd1a2Zsd3R2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0MjY1MzMsImV4cCI6MjA3ODAwMjUzM30.C7LNJktfiaGIWPdALInLxPPvJEJPsKto75RF6QJfk6o';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.runTests = async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="status info">Running tests...</div>';

            let html = '';

            // Test 1: Check connection
            html += '<h2>Test 1: Connection</h2>';
            try {
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                if (error) throw error;
                html += '<div class="status success">‚úÖ Connection successful!</div>';
            } catch (error) {
                html += `<div class="status error">‚ùå Connection failed: ${error.message}</div>`;
                if (error.message.includes('relation') || error.message.includes('does not exist')) {
                    html += '<div class="status info">‚ÑπÔ∏è This likely means the database tables haven\'t been created yet. You need to run the migrations in Supabase SQL Editor.</div>';
                }
            }

            // Test 2: Check listings table
            html += '<h2>Test 2: Listings Table</h2>';
            try {
                const { data, error } = await supabase.from('listings').select('*').limit(5);
                if (error) throw error;
                html += `<div class="status success">‚úÖ Listings table exists! Found ${data.length} listings</div>`;
                if (data.length > 0) {
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                } else {
                    html += '<div class="status info">‚ÑπÔ∏è No listings found. You may need to run the seed data migration (002_seed_data.sql).</div>';
                }
            } catch (error) {
                html += `<div class="status error">‚ùå Listings table error: ${error.message}</div>`;
                if (error.message.includes('relation') || error.message.includes('does not exist')) {
                    html += '<div class="status info">‚ÑπÔ∏è The listings table doesn\'t exist. You need to run the migration: <code>supabase/migrations/001_initial_schema.sql</code></div>';
                }
            }

            // Test 3: Check guests table
            html += '<h2>Test 3: Guests Table</h2>';
            try {
                const { data, error } = await supabase.from('guests').select('*').limit(5);
                if (error) throw error;
                html += `<div class="status success">‚úÖ Guests table exists! Found ${data.length} guests</div>`;
            } catch (error) {
                html += `<div class="status error">‚ùå Guests table error: ${error.message}</div>`;
            }

            // Test 4: Check RPC function
            html += '<h2>Test 4: RPC Function (get_device_config)</h2>';
            try {
                const { data, error } = await supabase.rpc('get_device_config', {
                    p_token: 'test-token'
                });
                if (error) throw error;
                html += '<div class="status success">‚úÖ RPC function exists!</div>';
            } catch (error) {
                html += `<div class="status error">‚ùå RPC function error: ${error.message}</div>`;
                if (error.message.includes('function') && error.message.includes('does not exist')) {
                    html += '<div class="status info">‚ÑπÔ∏è The RPC function doesn\'t exist. Make sure you\'ve run the full migration.</div>';
                }
            }

            html += '<h2>Summary</h2>';
            html += '<div class="status info">';
            html += '<p><strong>Next Steps:</strong></p>';
            html += '<ol>';
            html += '<li>Go to your <a href="https://supabase.com/dashboard/project/cymticrjzidywukflwtv/editor" target="_blank">Supabase SQL Editor</a></li>';
            html += '<li>Run <code>supabase/migrations/001_initial_schema.sql</code></li>';
            html += '<li>Run <code>supabase/migrations/002_seed_data.sql</code></li>';
            html += '<li>Update the user_id in seed data with your actual Supabase auth user ID</li>';
            html += '<li>Run this test again</li>';
            html += '</ol>';
            html += '</div>';

            resultsDiv.innerHTML = html;
        };
    </script>
</body>
</html>
